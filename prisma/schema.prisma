generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


enum SubmissionStatus {
  active
  inactive
}

enum ReportStatus {
  under_review
  approved
  rejected
}

enum UserStatus {
  active
  inactive
}

enum StudentStatus {
  active
  inactive
}


model Indicator {
  id        Int      @id @default(autoincrement())
  title     String   @unique
  value     Float    
  type      String  
  max       Float?
  min       Float?
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}


model Submission {
id        Int      @id @default(autoincrement())
  startDate DateTime @default(now()) 
  endDate   DateTime
  status    SubmissionStatus @default(active)
  stage     Int    
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  

  reports   Report[] 
}

model Report {
  id            Int      @id @default(autoincrement())
  groupId       Int    
  fileUrl       String   
  publicId      String?  
  submissionId  Int      
  status        ReportStatus @default(under_review)
  score         Float? 
  observations  String[]  
  keyResults    Json?  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  analyzedAt    DateTime?

  submission    Submission @relation(fields: [submissionId], references: [id])
  group         Group      @relation(fields: [groupId], references: [id])   

}

model Group {
  id        Int    @id @default(autoincrement())
  name      String
  course    String

  advisorId Int?
  advisor   Advisor? @relation("Advisor", fields: [advisorId], references: [id])

  coAdvisorId Int?
  coAdvisor   Advisor? @relation("CoAdvisor", fields: [coAdvisorId], references: [id])

  isPublished Boolean @default(false)
  publishedAt DateTime?

  reports   Report[]
  students  Student[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("groups")
}


model Student {
  id        Int      @id @default(autoincrement())
  user      User     @relation("UserToStudent", fields: [userId], references: [id], onDelete: Cascade)
  userId    Int      @unique

  ra        String?  @unique
  course    String?  
  class     String?         
  phone     String?         
  birthDate DateTime?

  status    StudentStatus @default(active)

  groupId   Int?
  group     Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("students")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   
  name      String
  phone     String?
  status    UserStatus @default(active)
  roles     UserRole[]

  student     Student?    @relation("UserToStudent")
  advisor     Advisor?    @relation("UserToAdvisor")
  coordinator Coordinator? @relation("UserToCoordinator")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?


  resetPasswordToken   String?
  resetPasswordExpires DateTime?
}


model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique     
  description String? 

 
  users       UserRole[]   

 
  permissions RolePermission[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}


model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique    
  action      String?             
  resource    String?                       
  description String?

  roles       RolePermission[]

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}


model UserRole {
  userId    Int
  roleId    Int

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, roleId])  
}

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId],       references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([roleId, permissionId])  
}


model Advisor {
  id        Int      @id @default(autoincrement())
  user      User     @relation("UserToAdvisor", fields: [userId], references: [id], onDelete: Cascade)
  userId    Int      @unique

  specialty String?
  lattes    String?

  advisedGroups   Group[] @relation("Advisor")
  coAdvisedGroups Group[] @relation("CoAdvisor")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}


model Coordinator {
  id        Int      @id @default(autoincrement())
  user      User     @relation("UserToCoordinator", fields: [userId], references: [id], onDelete: Cascade)
  userId    Int      @unique

  department String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}